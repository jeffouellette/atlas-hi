# Dear emacs, treat this as: -*- sh -*-
######
#
#  Numerical Inversion Configuration File for:
#
#    Anti-Kt R=4 topo jets at LC scale, weights applied
#

########################################################
#
#  A. Global settings
#
##

  # name for the job.
  # a good, descriptive name provides good default names
  # for the calibration root files and directories produced
JobName:		PbpJES
OutputDir: ./

  # for plot labeling
JetLabel:		Anti k_{T} R=0.4 (HI)
PreCalibration:		EM

  # number of events to run over. -1 for all!
NEvts:		-1

  # what eta range to process (-1 means no constraints)
MinAbsEta:      0.0
MaxAbsEta:	4.5

MinPtForETAJES: 12
MinPtETACorr: 8
MaxEETACorr: 2500

MinPhi:		-3.15
MaxPhi:		3.15
  # Number of iterations
  # the code will loop over the events once first
  # to derive base correction, then iterate Niterations times
  # and finally run one last time to do closure tests.
  # i.e. Niterations+2 times in total
Niterations:            3

  # Plot verbosity - increase to get more plots
  # 0 = no plots
  # 1 = only summary plots (one pdf file)
  # 2 = also final, closure R and eta distribution for each eta slice (many pdfs)
  # 3 = all plots for each iteration (lots of pdfs)
PlotVerbosity:          2

InputTree: merged
#InputTree: AntiKt4HIJets
#inFileName: /afs/cern.ch/work/g/gmarceca/public/hist-mc15_13TeV.361022.Pythia8EvtGen_A14NNPDF23LO_jetjet_JZ2W.merge.DAOD_JETM9.e3668_s2576_s2132_r6765_r6282_p2375.root
inFileName: /afs/cern.ch/work/j/jeouelle/CalibrationTrees/Pbp/MergedJES.root

useStatCut: false

#############################################
#
#  B. Fitting paramters and ranges
#
##

## Two methods descriped in the following paper:
## Options: first (RvsEtrue take R and use avg Ereco in bins of Etrue), 
## second (RvsEtrue, fit, estimate Ereco(est), RvsEreco ...)
NiMethod: second

## GCW and LC not well descriped in low E region by groom function
## EnableEMinExtrapolation: false gives better results in these cases
EnableEMinExtrapolation: false
MaxAcceptableYDeviationFitVSMinGroom: 0.3

## In case the number of data points in the R vs. E graph < MinNDataPointsForMinExtrapolation
## => EnableEMinExtrapolation=true forced ("JES_Function: polBestChi2+groom" only)
MinNDataPointsForMinExtrapolation: 3

MinEtForMeasurements:	20
MinEtForExtrapolation:	5.0
#MaxEForFits:	         4000
MaxEForFits:	         4000


# Fitting Tool implementation
# using fitting tool for individual gaussian fits

useEFitTool:    true
usePtFitTool:   true
useEtaFitTool:  true

GausFitRangeNSigma:             1.7
pTCorrGausFitRangeNSigma:       1.9
EtaCorrGausFitRangeNSigma:      1.7

#***** To get closure in the last energy bin in the FCal eta range************* 
useGeoDetCorr: True
#minGeoDetCorr: 2.5
minGeoDetCorr: 0.8
#maxGeoDetCorr: 3.5
maxGeoDetCorr: 1.0
#******************************************************************************

#
# B.1 : The JES Calibration
# -------------------------

MinEtForEnergyResponseFit:	20

  # how do we define the response?
EnergyResponseDef:              GausMean

# Calibration funciton to be used, and function for iterative correction
# Default: polBestChi2+groom
#JES_Function:     groom
JES_Function:     polBestChi2
#JES_Function:     polBestChi2+groom

## Max possible order reduced dependent on the number of data points in RvsE
## maxOrder = (Int_t)(P1*exp(P2*((double)g->GetN()))+P3)
JES_MaxOrderP1: -3.1
JES_MaxOrderP2: -0.05
JES_MaxOrderP3: 5.5

  # Gaussian fitting range: mean +/- N*RMS
GausFitMinET:                   8.5

  # whether to make the erf x Gaus fit
MakeErfGausFit:		0
ErfGausFitRangeNSigma:  1.8

#
# B.2 : The Jet Eta Correction
# -------------------------

MinEtForMassResponseFit:        12
EtaCorrDef:                     Gaus

EtaCorr_MaxOrderP1: -3.0
EtaCorr_MaxOrderP2: -0.25
EtaCorr_MaxOrderP3: 3.95


#
# B.3 : The Jet Mass Calibration : Jet Mass Response (JMS)
# -------------------------

MinEtForEtaCorrFit:	        8

  # how do we define the response?
MassResponseDef:                GausMean


MassCorrGausFitRangeNSigma:     1.0

  # Scale by cross section?
  # WARNING: applying event weights introduces complications ...
  #          See section H below
ApplyWeights:		true


  # Rebin of the Response histogram - originally 240 bins in [0,2.4]
  # 0 (or smaller) means optimal (re)binning
RHistoRebin:		0

  # Parameter for optimal binning. 
  # Lower gives more bins. Scot's choise is 3.5
  # Optimal binning avoids bad fits due to too many bins.
OptimalBinningParam:	3.2

  # For the Eta Correction (in Etrue)
EtaCorrETBins:		10 15 20 32 60 100 160 280 500 1000 2000 3500

EtaException:
JES_MaxOrderException: 7
EnableEMinExtrapolationException: false 
EnableEMaxExtrapolationException: false

# ----------------------
# 2. For histogram creation

#EBins:			0 4 7 8 9 10 11 12 13 14 15 16 18 20
#+EBins:			22 24 26 28 30 32 35 40 45 50 55 60
#+EBins:			70 75 80 85 90 100 110 120 130 140 150 160
#+EBins:			180 200 220 240 260 280 300 320 350 400
#+EBins:			450 500 550 600 650 700 750 800 850 900
#+EBins:			1000 1100 1200 1300 1400 1500 1600 1700
#+EBins:			1800 1900 2000 2100 2200 2300 2400 2500
#+EBins:			2600 2800 3000 3200 3500

#EBins:            20 25 30 35 40 50
#+EBins:            60 80 100 120 150 200 240 300 400 500 600 800
#+EBins:            1000 1200 1500 2000 2500 3000 3500 4000 5500

EBins:      10 12 15 18 22 26 30 35 40 45 50
+EBins:     55 60 65 70 75 80 85 90 100 120 140
+EBins:     160 180 200 220 240 260 280 300 320 360 400
+EBins:     450 500 550 600 700 800 900 1000 1200 1400
+EBins:     1600 1800 2000 2200 2600 3000 3500 4000 5000


PBins:            20 25 30 35 40 50
+PBins:            60 80 100 120 150 200 240 300 400 500 600 800
+PBins:            1000 1200 1500 2000 2500 3000 4000

# For testing
#AbsEtaBins: 0.0 0.1 0.2

AbsEtaBins:		  0.0 0.1 0.2 0.3 0.4 0.5 0.6 0.7 0.8 0.9
+AbsEtaBins:		  1.0 1.1 1.2 1.3 1.4 1.5 1.6 1.7 1.8 1.9
+AbsEtaBins:		  2.0 2.1 2.2 2.3 2.4 2.5 2.6 2.7 2.8 2.9
+AbsEtaBins:		  3.0 3.1 3.2 3.3 3.4 3.5 3.6 3.7 3.8 3.9
+AbsEtaBins:		  4.0 4.1 4.2 4.3 4.4 4.5




######################################### Phi dependence ##################################

PhiBins:		  -3.15 -3.05 -2.95 -2.85 -2.75 -2.65 -2.55 -2.45 -2.35
+PhiBins:		-2.25 -2.15 -2.05 -1.95 -1.85 -1.75 -1.65 -1.55 -1.45 -1.35
+PhiBins:		-1.25 -1.15 -1.05 -0.95 -0.85 -0.75 -0.65 -0.55 -0.45 -0.35
+PhiBins:		-0.25 -0.15 -0.05 0.05 0.15 0.25 0.35 0.45 0.55 0.65 0.75
+PhiBins:		0.85 0.95 1.05 1.15 1.25 1.35 1.45 1.55 1.65 1.75 1.85 1.95
+PhiBins:		2.05 2.15 2.25 2.35 2.45 2.55 2.65 2.75 2.85 2.95 3.05 3.15

########################################################################################



  # for jet response
#Histo_NRBins:           240
Histo_NRBins:           240
#Histo_NRBins:           30
Histo_RMin:             0
Histo_RMax:             2.4

  # for eta correction histos, this many bins between -max and max
Histo_NDeltaEtaBins:    1400
Histo_NDeltaErecoBins:    300
Histo_DeltaEtaMax:      0.5


#######################################
#
#  D. Fitting parameters
#
##

  # should be better when using weighted events. False for non-weighted events
  # see the ApplyWeights parameter below!
IgnoreBinErrorsForFit:	true

  # minimal statsistics requirement:
  # require at least this many jets in each bin, or merge with the next
MinNEffectiveP1: -3.1
MinNEffectiveP2: 1.05
MinNEffectiveP3: 400


#############################################
#
#  F. Names for output directories
#
#  Note: Default names are based on the NumInvName config parameter close
#        to the top of this file.
##

  # output directory for root files, calibration constatns and the summary webpage
  # default: same as NumInvName
OutputDirectory:        ./

JetAlgos: AntiKt4HIJets



